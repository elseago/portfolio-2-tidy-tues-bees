---
title: "portfolio-2-tidy-tues-bees"
author: "Elayna Seago"
date: "2/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

My goals for my bee colony portfolio project are to:
1) get practice using Tidy Tuesday data
2) determine what 10 states/times experienced the greatest loss in colony numbers over a 3 month period. 
3) make a graph for the stressors in each of those states in their worst year.


```{r bee-data}

colony <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/colony.csv')
stressor <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/stressor.csv')


```


```{r libraries}
library(rvest)
library(tidyverse)
library(fs)
```



```{r}
# download site
url <- "https://usda.library.cornell.edu/concern/publications/rn301137d?locale=en"


```


```{r clean-data}


# raw html
raw_html <- read_html(url)

# all the download urls for zip files
all_urls <- raw_html %>% 
  html_elements("#content-wrapper > div.row.p-content > div.col-sm-7 > table") %>% 
  html_elements("a") %>% 
  html_attr("href") %>% 
  str_subset(".zip") 

# download to correct directory
download.file(all_urls, destfile = paste0("2022/2022-01-11/", basename(all_urls)))

# unzip into their respective folders
walk(basename(all_urls), ~ unzip(
  paste0("2022/2022-01-11/", .x),
  exdir = paste0("2022/2022-01-11/bee-", str_sub(.x, -6, -5))
))


 # Clean Colony data ------------------------------------------------------


clean_bee_colonies <- function(file){
  
  col_labs <- c("state", "colony_n", "colony_max", "colony_lost", 
    "colony_lost_pct", "colony_added", "colony_reno", "colony_reno_pct")
  
  raw_df <- read_csv(file,  skip = 2, col_names = FALSE)
  
  date_rng <- read_csv(file, skip = 0, col_names = FALSE) %>% 
    slice(2) %>% 
    pull(X3) %>% 
    str_replace(" [5-6]/$", "") %>% 
    word(-2, -1)
  
  clean_df <- suppressWarnings(raw_df %>% 
    filter(!is.na(X4))  %>%
    filter(X2 == "d") %>% 
    select(X3:X10) %>% 
    set_names(nm = col_labs) %>% 
    mutate(date_range = date_rng, .before = state) %>% 
    separate(date_range, into = c("months", "year"), sep = " ") %>% 
    select(year, months, state, everything()) %>% 
    mutate(across(contains("colony"), as.integer)))
  
  clean_df
}


 #Clean stress data -------------------------------------------------------


clean_bee_stress <- function(file){
  
  col_labs <- c("state", "colony_n", "colony_max", "colony_lost", 
    "colony_lost_pct", "colony_added", "colony_reno", "colony_reno_pct")

  
  raw_df <- read_csv(file,  skip = 4, col_names = FALSE)
  
  date_rng <- read_csv(file, skip = 0, col_names = FALSE) %>% 
    slice(2) %>% 
    pull(X3) %>% 
    str_replace(" [5-6]/$", "") %>% 
    word(-2, -1)
  
  stress_nm <- c("state", "Varroa mites", "Other pests/parasites", "Disesases",
    "Pesticides", "Other", "Unknown")
  
  clean_df <- suppressWarnings(raw_df %>% 
      filter(!is.na(X4))  %>%
      filter(X2 == "d") %>% 
      select(X3:X9) %>% 
      set_names(nm = stress_nm) %>% 
      pivot_longer(cols = -state, names_to = "stressor", values_to = "stress_pct") %>% 
      mutate(date_range = date_rng, .before = state) %>% 
      separate(date_range, into = c("months", "year"), sep = " ") %>% 
      select(year, months, state, everything()) %>% 
      mutate(stress_pct = as.double(stress_pct)))
  
  clean_df
}


```


```{r clean-data-step-2}
# Get the file index ------------------------------------------------------


all_html_index <- dir_ls("2022/2022-01-11", recurse = TRUE, glob = "*htm") %>% 
  str_subset("bee-") %>% 
  str_subset("index")

get_index <- function(index_file){
  ind_yr <- str_sub(index_file, -17, -16)
  
  raw_text <- index_file %>% 
    read_html() %>%
    html_text() %>% 
    str_split("\r\n[0-9]+") %>% 
    unlist() %>% 
    map(~str_split(.x, "\r\n")) 
  
  raw_text %>% 
    tibble(data = .) %>% 
    unchop(data) %>% 
    unnest_wider(data) %>% 
    select(file = ...2, desc = ...3) %>% 
    mutate(type = case_when(
      str_detect(desc, "Colonies, Maximum, Lost") ~ "Colony",
      str_detect(desc, "Colony Health Stressors") ~ "Stressor",
      TRUE ~ NA_character_
    )) %>% 
    filter(!is.na(type)) %>% 
    mutate(year = ind_yr, .before = file)
  
}

all_index_files <- map_dfr(all_html_index, get_index)

# Split data by type
split_files <- all_index_files %>% 
  mutate(dir_file = glue::glue("2022/2022-01-11/bee-{year}/{file}")) %>% 
  select(type, dir_file, year, file, desc) %>% 
  group_split(type)

# aggregate the clean data by type

all_colonies <-  map_dfr(split_files[[1]]$dir_file, clean_bee_colonies) %>% 
  distinct(year, months, state, .keep_all = TRUE) %>% 
  mutate(state = str_remove(state, " 4/| 5/")) %>% 
  filter(state %in% c(state.name, "Other States", "United States"))

all_stress <-  map_dfr(split_files[[2]]$dir_file, clean_bee_stress) %>% 
  distinct(year, months, state, stressor, .keep_all = TRUE) %>% 
  mutate(state = str_remove(state, " 4/| 5/")) %>% 
  filter(state %in% c(state.name, "Other States", "United States"))

# check data
all_colonies %>% 
  count(year, months) %>% 
  filter(n > 47)

all_stress %>% 
  count(year, months) %>% 
  filter(n > 282)

all_colonies %>% 
  write_csv("2022/2022-01-11/colony.csv")

all_stress %>% 
  write_csv("2022/2022-01-11/stressor.csv")

```


### I wanted to see where the greatest 1 year losses in bee colonies were. I found that New Mexico had the worst 3 month period and also the 10th and 11th worst 3 month periods.

```{r get-top-ten}
max_colony_loss <- all_colonies %>%              
  arrange(desc(colony_lost_pct)) %>% 
  slice(1:10)

max_colony_loss
```

#fix this graph-only 1 new mexico
```{r make-graph}
max_colony_loss%>% 
  ggplot(aes(x = reorder(state , -colony_lost_pct) , y = colony_lost_pct)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) 
```

After making this graph I realized I need to glue state, month, and year together because otherwise New Mexico is very misleading.

```{r glue}
library(glue)

max_colony_loss %>% 
  mutate(
    time_place = glue("{year} {months} {state}")
  ) %>% 
  ggplot(aes(x = reorder(time_place , -colony_lost_pct) , y = colony_lost_pct)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) 
```

### Goal number 3
I think it will be helpful to join the two data sets for this portion.
```{r}
colonies_stressors <- full_join(all_colonies, all_stress, by =  c("year" , "months" , "state"))

colonies_stressors

```
#re-do the filter thing I did before to get the top 10 worst sections and do the glueing-sliced for 1:60 because it is the long version of data
# okay-confusion. because I joined these and the all_stress one had a pivot longer situation, the graph y axis needs to be divided by 6... but i don't know the "reproducible" way to do this.
## what i was doing does not make any sense. stressor is not a meaningful variable. stress_pct is.
# revisit this mess- how is percent stress above 100?
```{r}
max_colony_loss_stress <- colonies_stressors %>%              
  arrange(desc(colony_lost_pct)) %>% 
  slice(1:60)

max_colony_loss_stress %>% 
  mutate(
    time_place = glue("{year} {months} {state}")
  ) %>% 
  ggplot(aes(x = time_place , y = stress_pct , fill = stressor)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) 
```

